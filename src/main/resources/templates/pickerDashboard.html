<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picker Dashboard - Warehouse Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .stat-card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.2s;
            height: 100%;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #0d6efd;
        }
        
        .stat-number {
            font-size: 1.75rem;
            font-weight: 600;
            margin: 0.5rem 0;
        }
        
        .task-card {
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .task-card .card-header {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .task-table th {
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .task-row {
            transition: background-color 0.2s;
        }

        .task-row:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-pending {
            background-color: #ffc107;
            color: #000;
        }

        .badge-in-progress {
            background-color: #0dcaf0;
            color: #000;
        }

        .badge-completed {
            background-color: #198754;
            color: #fff;
        }

        .action-btn {
            min-width: 100px;
        }

        .priority-high {
            color: #dc3545;
            font-weight: 600;
        }

        .priority-medium {
            color: #fd7e14;
            font-weight: 600;
        }

        .priority-low {
            color: #20c997;
            font-weight: 600;
        }

        .task-details {
            font-size: 0.9rem;
        }

        .task-actions .btn {
            min-width: 100px;
        }
    </style>
</head>
<body>
<!-- Include common header -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-cart-check me-2"></i>Picker Dashboard
        </h1>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="window.location.reload()">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-list-check stat-icon"></i>
                    <h3 class="stat-number" th:text="${stats?.assignedPicks ?: 0}">0</h3>
                    <p class="text-muted mb-0">Assigned Picks</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-check-circle stat-icon"></i>
                    <h3 class="stat-number" th:text="${stats?.completedToday ?: 0}">0</h3>
                    <p class="text-muted mb-0">Completed Today</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-clock-history stat-icon"></i>
                    <h3 class="stat-number" th:text="${stats?.avgPickTime ?: '0:00'}">0:00</h3>
                    <p class="text-muted mb-0">Avg. Pick Time</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up-arrow stat-icon"></i>
                    <h3 class="stat-number" th:text="${stats?.accuracy ?: '0%'}">0%</h3>
                    <p class="text-muted mb-0">Pick Accuracy</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Picking Tasks -->
    <div class="card task-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-list-task me-2"></i>Picking Tasks
            </h5>
            <span class="badge bg-primary">
                    <span th:text="${#lists.size(pickingTasks)}">0</span> Tasks
                </span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Items</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Assigned</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="task : ${pickingTasks}" class="task-row">
                        <td th:text="'#' + ${task.orderNumber}">#12345</td>
                        <td th:text="${task.customerName}">John Doe</td>
                        <td th:text="${task.itemCount} + ' items'">5 items</td>
                        <td>
                                    <span th:class="'priority-' + ${task.priority?.toLowerCase()}"
                                          th:text="${task.priority}">Medium</span>
                        </td>
                        <td>
                                    <span th:class="'badge ' + ${'badge-' + task.status?.toLowerCase().replace(' ', '-')}"
                                          th:text="${task.status}">Pending</span>
                        </td>
                        <td th:text="${#temporals.format(task.assignedDate, 'MMM d, yyyy')}">Jan 1, 2023</td>
                        <td>
                            <div class="btn-group task-actions" role="group">
                                <button th:if="${task.status == 'Pending'}"
                                        class="btn btn-sm btn-outline-primary"
                                        th:onclick="'startTask(' + ${task.id} + ')'">
                                    <i class="bi bi-play-fill me-1"></i> Start
                                </button>
                                <button th:if="${task.status == 'In Progress'}"
                                        class="btn btn-sm btn-success"
                                        th:onclick="'completeTask(' + ${task.id} + ')'">
                                    <i class="bi bi-check-circle me-1"></i> Complete
                                </button>
                                <button class="btn btn-sm btn-outline-secondary"
                                        th:onclick="'viewDetails(' + ${task.id} + ')'">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(pickingTasks)}">
                        <td colspan="7" class="text-center py-4">
                            <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
                            <p class="mb-0">No picking tasks assigned</p>
                            <p class="text-muted small">New tasks will appear here when assigned</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Showing <span th:text="${#lists.size(pickingTasks)}">0</span> of
                    <span th:text="${totalTasks ?: '0'}">0</span> tasks
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" th:class="${currentPage == 0} ? 'disabled' : ''">
                            <a class="page-link" th:href="@{/picker?page={page}(page=${currentPage - 1})}">Previous</a>
                        </li>
                        <li th:each="page : ${#numbers.sequence(0, totalPages - 1)}"
                            th:class="'page-item' + (${page} == ${currentPage} ? ' active' : '')">
                            <a class="page-link" th:href="@{/picker?page={page}(page=${page})}"
                               th:text="${page + 1}">1</a>
                        </li>
                        <li class="page-item" th:class="${currentPage >= totalPages - 1} ? 'disabled' : ''">
                            <a class="page-link" th:href="@{/picker?page={page}(page=${currentPage + 1})}">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Task Details Modal -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="taskDetailsContent">
                <!-- Task details will be loaded here via JavaScript -->
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="printPickingList">
                    <i class="bi bi-printer me-1"></i> Print Picking List
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Function to start a picking task
    function startTask(taskId) {
        fetch(`/picker/start-task/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                showAlert('Failed to start task', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An error occurred while starting the task', 'danger');
        });
    }

    // Function to complete a picking task
    function completeTask(taskId) {
        if (confirm('Are you sure you want to mark this task as complete?')) {
            fetch(`/picker/complete-task/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    showAlert('Failed to complete task', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while completing the task', 'danger');
            });
        }
    }

    // Function to view task details
    function viewDetails(taskId) {
        const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
        const content = document.getElementById('taskDetailsContent');

        // Show loading spinner
        content.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;

        // In a real application, you would fetch the task details here
        // For now, we'll simulate a delay and show sample data
        setTimeout(() => {
            content.innerHTML = `
                <div class="task-details">
                    <h6 class="mb-3">Order #${taskId}</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Customer:</strong> John Doe</p>
                            <p class="mb-1"><strong>Items:</strong> 5</p>
                            <p class="mb-1"><strong>Priority:</strong> <span class="priority-high">High</span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> <span class="badge bg-primary">In Progress</span></p>
                            <p class="mb-1"><strong>Assigned:</strong> ${new Date().toLocaleDateString()}</p>
                            <p class="mb-1"><strong>Due:</strong> ${new Date(Date.now() + 86400000).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>SKU</th>
                                    <th>Quantity</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Widget A</td>
                                    <td>WID-001</td>
                                    <td>2</td>
                                    <td>A-12-05</td>
                                    <td><span class="badge bg-success">Picked</span></td>
                                </tr>
                                <tr>
                                    <td>Gadget B</td>
                                    <td>GAD-042</td>
                                    <td>1</td>
                                    <td>B-07-12</td>
                                    <td><span class="badge bg-warning text-dark">Pending</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <h6>Notes:</h6>
                        <p class="text-muted">Please handle with care. Fragile items included.</p>
                    </div>
                </div>
            `;
        }, 500);

        modal.show();
    }

    // Function to show alert messages
    function showAlert(message, type = 'info') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        alert.role = 'alert';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }

    // Print picking list handler
    document.getElementById('printPickingList')?.addEventListener('click', () => {
        window.print();
    });

    // Auto-refresh the page every 2 minutes
    setInterval(() => {
        window.location.reload();
    }, 120000);

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
</body>
</html>