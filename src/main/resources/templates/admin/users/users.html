<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Warehouse Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .badge {
            font-size: 0.75em;
            vertical-align: middle;
        }
        .table th {
            white-space: nowrap;
        }
        .table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">Warehouse SB</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" th:href="@{/admin}">Dashboard</a>
            <span class="nav-item nav-link">Welcome, <span th:text="${username}"></span></span>
            <a class="nav-link" th:href="@{/logout}">Logout</a>
        </div>
    </div>
</nav>


<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-users me-1"></i>
        Active User Sessions
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="activeUsersTable" width="100%" cellspacing="0">
                <thead>
                <tr>
                    <th>Username</th>
                    <th>Login Time</th>
                    <th>Last Activity</th>
                    <th>IP Address</th>
                    <th>Device</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="activeUser : ${activeUsers}"
                    th:class="${#strings.equals(currentUser, activeUser.username)} ? 'table-primary'">
                    <td th:text="${activeUser.username}"></td>
                    <td th:text="${#temporals.format(activeUser.loginTime, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td th:text="${#temporals.format(activeUser.lastActivity, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td th:text="${activeUser.ipAddress}"></td>
                    <td th:with="userAgent=${activeUser.userAgent}">
                            <span th:if="${#strings.length(userAgent) > 50}"
                                  th:title="${userAgent}">
                                <span th:text="${#strings.substring(userAgent, 0, 47)} + '...'"></span>
                            </span>
                        <span th:unless="${#strings.length(userAgent) > 50}"
                              th:text="${userAgent}">
                            </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">User Management</h2>
                    <a th:href="@{/admin/users/new}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-lg"></i> Add New User
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Roles</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="user : ${users}">
                                <td th:text="${user.id}"></td>
                                <td th:text="${user.username}"></td>
                                <td>
                                            <span th:each="role, stat : ${user.roles}"
                                                  th:text="${role} + (${!stat.last} ? ', ' : '')"></span>
                                </td>
                                <td>
                                    <a th:href="@{/admin/users/{id}/edit(id=${user.id})}"
                                       class="btn btn-sm btn-warning me-2">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                    <form th:if="${user.username != 'admin'}"
                                          th:action="@{/admin/users/{id}/delete(id=${user.id})}"
                                          method="post"
                                          class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-danger"
                                                onclick="return confirm('Are you sure you want to delete this user?')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Add this script at the bottom of your users.html -->
<script th:inline="javascript">
    function updateActiveSessions() {
        fetch('/api/user-sessions/active')
            .then(response => response.json())
            .then(sessions => {
                const tbody = document.querySelector('#activeUsersTable tbody');
                tbody.innerHTML = ''; // Clear current rows

                sessions.forEach(session => {
                    const row = document.createElement('tr');
                    if (session.username === /*[[${#authentication.name}]]*/ '') {
                        row.classList.add('table-primary');
                    }

                    // Format date and time with activity type
                    const formatDateTime = (dateTimeStr, activityType) => {
                        if (!dateTimeStr) return 'N/A';
                        const date = new Date(dateTimeStr);
                        if (isNaN(date.getTime())) return 'Invalid date';
                        
                        // Format the date and time
                        const formattedDate = date.toLocaleString();
                        
                        // Map activity types to user-friendly strings
                        const activityMap = {
                            'LOGIN': 'Logged in',
                            'PAGE_VIEW': 'Viewed page',
                            'API_CALL': 'Made API call',
                            'FORM_SUBMIT': 'Submitted form'
                        };
                        
                        const activityText = activityMap[activityType] || activityType || 'Performed action';
                        return `${formattedDate}<br><small class="text-muted">${activityText}</small>`;
                    };

                    const loginTime = formatDateTime(session.loginTime, 'LOGIN');
                    const lastActivity = formatDateTime(session.lastActivity, session.lastActivityType);

                    // Create and append cells
                    row.innerHTML = `
                        <td>${session.username} ${session.username === /*[[${#authentication.name}]]*/ '' ?
                            '<span class="badge bg-primary ms-2">You</span>' : ''}</td>
                        <td>${loginTime}</td>
                        <td>${lastActivity}</td>
                        <td>${session.ipAddress || 'N/A'}</td>
                        <td title="${session.userAgent || ''}">
                            ${session.userAgent ? (session.userAgent.length > 50 ?
                                session.userAgent.substring(0, 47) + '...' : session.userAgent) : 'N/A'}
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching active sessions:', error));
    }

    // Update sessions every 5 seconds
    setInterval(updateActiveSessions, 5000);
    // Initial load
    document.addEventListener('DOMContentLoaded', updateActiveSessions);
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</body>
</html>